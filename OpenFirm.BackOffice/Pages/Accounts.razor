@page "/accounts"
@inject HttpClient Http
@inject ISnackbar Snackbar
@using OpenFirm.BackOffice.Data;
@using System.Net.Http.Json

<MudText Typo="Typo.h3" GutterBottom="true">Accounts</MudText>

<MudTable T="AccountData" ServerData="ServerReload"
    Dense="true"
    Hover="true"
    @ref="_table">
    
    <ToolBarContent>
        <MudText Typo="Typo.h6">Accounts</MudText>
        <MudSpacer />
        <MudTextField T="string" ValueChanged="@(s => OnSearch(s))" Placeholder="Search..." 
          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Class="mt-0">

        </MudTextField>
    </ToolBarContent>

    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>Name</MudTh>
        <MudTh>Balance</MudTh>
        <MudTh>Initial Balance</MudTh>
        <MudTh>Status</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd DataLabel="ID">@context.Id</MudTd>
        <MudTd DataLabel="Name">@context.TraderName</MudTd>
        <MudTd DataLabel="Balance">@context.Balance</MudTd>
        <MudTd DataLabel="Initial Balance">@context.InitialBalance</MudTd>
        <MudTd DataLabel="Status">@context.Status</MudTd>
    </RowTemplate>

    <NoRecordsContent>
        <MudText>No records.</MudText>
    </NoRecordsContent>

    <PagerContent>
        <MudTablePager />
    </PagerContent>

</MudTable>

@code {
    private MudTable<AccountData> _table;
    private string _search = "";

    private async Task<TableData<AccountData>> ServerReload(TableState state, CancellationToken token)
    {
        try
        {
            var page = state.Page;
            var pageSize = state.PageSize;

            var url = $"api/account/search?search={_search}&page={page}&pageSize={pageSize}";

            var response = await Http.GetFromJsonAsync<QueryResult<AccountData>>(url);

            if (response == null)
            {
                return new TableData<AccountData>() { TotalItems = 0, Items = new List<AccountData>() };
            }

            return new TableData<AccountData>() { TotalItems = response.TotalItems, Items = response.Data };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Snackbar.Add($"Critical error: {ex.Message}");
            return new TableData<AccountData>() { TotalItems = 0, Items = new List<AccountData>() };
        }
    }

    private void OnSearch(string text)
    {
        _search = text;
        _table.ReloadServerData();
    }
}
